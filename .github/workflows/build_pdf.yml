name: Build and Deploy Documentation

on:
  push:
    branches: [main]
    paths:
      - 'software/documentation/**'
      - 'software/sphinx/**'
      - 'README.md'
      - 'hardware/**'
      - '.github/workflows/build_pdf.yml'
  pull_request:
    branches: [main]
    paths:
      - 'software/documentation/**'
      - 'software/sphinx/**'
      - 'README.md'
      - 'hardware/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies (Python + LaTeX + Ghostscript)
      run: |
        sudo apt-get update
        sudo apt-get install -y texlive-latex-extra texlive-fonts-recommended texlive-lang-english ghostscript latexmk
        pip install -r software/sphinx/requirements.txt
        pip install Jinja2

    #################################################
    # Generar Documentaci√≥n Sphinx (HTML + PDF)
    #################################################
    - name: Build Sphinx Documentation
      working-directory: software/sphinx
      run: |
        make clean
        make pdfx

    #################################################
    # Preparar contenido para docs/
    #################################################
    - name: Prepare docs/ directory
      env:
        REPO_NAME: ${{ github.event.repository.name }}
      run: |
        # Limpiar y recrear directorio docs/
        rm -rf docs
        mkdir -p docs

        # Copiar HTML generado por Sphinx directamente a docs/
        rsync -av software/sphinx/docs/ docs/

        # Copiar PDF generado por Sphinx
        cp software/sphinx/pdf/programmer.pdf docs/${REPO_NAME}_sphinx.pdf

    #################################################
    # Deploy to GitHub Pages (direct and fast)
    #################################################
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        publish_branch: gh-pages
        force_orphan: false
        keep_files: false
        enable_jekyll: false
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
